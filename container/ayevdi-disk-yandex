# ayevdi
# Virtualized Deployment IaaS (VDI) by AyeAI
# 
# NOTICE
# Copyright (C) 2019 Abhishek Choudhary
# 
# To all WHO IT MAY CONCERN,
# Greetings,
# All artifacts and methods in this project are offered with 
# NO WARRANTY, and ZERO LIABILITY (Limited to INR 1/- only),
# subject to the jurisdictions of courts in Hyderabad, India,
# and solely in accordance with AyeAI SPL version 1, or later,
# as expressed at the follow URL and at the most current update
# https://raw.githubusercontent.com/ayeai/spl/master/LICENSE
# incuding its clauses of automatic implicit update of license,
# and unless in conflict the terms and conditions of GNU GPL v2
# shall apply with no retort to other GPL licenses, AND, These
# terms and conditions are implied read, understood and accepted
# by the access, or usage of these artifacts and methods which
# must STRICTLY be IN ACCORDANCE, and this notice must be 
# reproduced in derivatives along with the original assertions
# of copyrights.

ayeai_spl_show_copyright() {
  echo "Copyright (C) 2019 Abhishek Choudhary"
  echo ""
}

ayeai_spl_notice() {
  echo "AyeAI has created this script only as a support utility"
  echo "to improve the user experience for users using the AyeVDI"
  echo "platform in accordance with AyeAI SPL version 1 or later."
  echo "https://raw.githubusercontent.com/ayeai/spl/master/LICENSE"
  echo "AyeAI may not in any way be associated with the third party"
  echo "providers and NO WARRANTY on any SLAs or privacy levels are"
  echo "asserted with regards to such services."
  echo ""
}

ayeai_spl_3rd_party_eula() {
  echo "The software referenced in this utility may be governed by"
  echo "the legal agreement available at"
  echo $1
  echo "or at other locations as specified by"
  echo $2
  echo ""
}

ayeai_spl_choice() {
  echo "By proceeding to use this software you accept the terms"
  echo "and conditions of the above agreements, and acknowledge to"
  echo "have read and understood the same. You further indemnify"
  echo "AyeAI and its affiliates against any liabilities to your"
  echo "person or property, or to the person or property of others."
  echo "Not acceptating this agreement DOES NOT IMPACT your other"
  echo "agreements with AyeAI and its affiliates, or with other"
  echo "third party providers."
  echo ""
}

ayeai_spl_custom_config_notice () {
  echo "This utility will autofill or select certain options so"
  echo "that you have a seamless experience. If you do not agree"
  echo "with the defaults selected, please DO NOT use this utility."
  echo "You may also execute the program yourself directly from"
  echo $2
  echo "or as specified at"
  echo $3
  echo ""
}

ayeai_spl_respectful_denial() {
  echo "You have opted to not accept the terms and conditions."
  echo "We respect that! Please note that this does not"
  echo "invalidate your other existing agreements with AyeAI."
  echo ""
}

ayeai_tool_init_3rd_party_custom() {
  ayeai_spl_show_copyright
  ayeai_spl_notice
  ayeai_spl_3rd_party_eula $1 $2
  ayeai_spl_choice
  ayeai_spl_custom_config_notice $3 $4
}

ayedisk_unset_home () {
  export AYEDISK_HOME=${HOME} &&\
  echo "Your persistent disk is unset."
  echo ""
}

ayedisk_confirm_activate() {
  read -p "Do you wish to proceed at your own risk? (y/N) " choice
  if [ "${choice}" = "y" ] || [ "${choice}" = "Y" ]
  then
    echo ""
    export AYEDISK_HOME=${HOME}/ayework/${1}
    if [ ! -f $2 ]
    then
      install_prog
    fi

    if [ -e ${HOME}/ayework/${1} ]
    then
      echo "${1} already running?"
    else
      auth_prog
    fi
    $2 "start" &&\
    echo "Your persistent disk is available at" &&\
    echo ${AYEDISK_HOME} ||\
    echo "AyeVDI: Error starting " ${prog} &&\
    ayedisk_unset_home
  else
    ayeai_spl_respectful_denial
    ayedisk_unset_home
  fi
}

## End library section ##

prog="/usr/bin/yandex-disk"

install_prog() {
  # Based on instructions available at https://yandex.com/support/disk/cli-clients.html
  echo "deb http://repo.yandex.ru/yandex-disk/deb/ stable main" | sudo tee -a /etc/apt/sources.list.d/yandex-disk.list > /dev/null &&\
  wget http://repo.yandex.ru/yandex-disk/YANDEX-DISK-KEY.GPG -O- | sudo apt-key add - &&\
  sudo apt-get update &&\
  sudo apt-get install -y yandex-disk
}

auth_prog() {
  read -p "Username: " uuid
  read -s -p "Password: " upwd

  mkdir -p ${HOME}/ayework/
  /usr/bin/expect <<EOF
    spawn "${prog}" "setup"
    expect "Would you like to use a proxy server?"
      send "n\r"
    expect "Enter username:"
      send "${uuid}\r"
    expect "Enter password:"
      send "${upwd}\r"
    expect "/Yandex.Disk'):"
      send "${AYEDISK_HOME}\r"
    expect "Would you like Yandex.Disk to launch on startup?"
      send "y\r"
    expect eof
    exit
EOF
}

ayeai_tool_init_3rd_party_custom \
  "https://yandex.com/legal/desktop_software_agreement/"\
  "https://yandex.com"\
  "https://yandex.com/support/disk/cli-clients.html"\
  ${prog}

ayedisk_confirm_activate "Yandex.Disk" ${prog}
